<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>Untitled</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	text-indent: -1.7em;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, YuMincho, "Yu Mincho", "Hiragino Mincho ProN", "Hiragino Mincho Pro", "Songti TC", "Songti SC", "SimSun", "Nanum Myeongjo", NanumMyeongjo, Batang, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC', 'Noto Sans CJK KR'; }

.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC', 'Noto Sans Mono CJK KR'; }

.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, YuMincho, "Yu Mincho", "Hiragino Mincho ProN", "Hiragino Mincho Pro", "Songti TC", "Songti SC", "SimSun", "Nanum Myeongjo", NanumMyeongjo, Batang, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC', 'Noto Sans CJK KR'; }

.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC', 'Noto Sans Mono CJK KR'; }

.highlight-default {
}
.highlight-gray {
	color: rgb(155,154,151);
}
.highlight-brown {
	color: rgb(100,71,58);
}
.highlight-orange {
	color: rgb(217,115,13);
}
.highlight-yellow {
	color: rgb(223,171,1);
}
.highlight-teal {
	color: rgb(15,123,108);
}
.highlight-blue {
	color: rgb(11,110,153);
}
.highlight-purple {
	color: rgb(105,64,165);
}
.highlight-pink {
	color: rgb(173,26,114);
}
.highlight-red {
	color: rgb(224,62,62);
}
.highlight-gray_background {
	background: rgb(235,236,237);
}
.highlight-brown_background {
	background: rgb(233,229,227);
}
.highlight-orange_background {
	background: rgb(250,235,221);
}
.highlight-yellow_background {
	background: rgb(251,243,219);
}
.highlight-teal_background {
	background: rgb(221,237,234);
}
.highlight-blue_background {
	background: rgb(221,235,241);
}
.highlight-purple_background {
	background: rgb(234,228,242);
}
.highlight-pink_background {
	background: rgb(244,223,235);
}
.highlight-red_background {
	background: rgb(251,228,228);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(55, 53, 47, 0.6);
	fill: rgba(55, 53, 47, 0.6);
}
.block-color-brown {
	color: rgb(100,71,58);
	fill: rgb(100,71,58);
}
.block-color-orange {
	color: rgb(217,115,13);
	fill: rgb(217,115,13);
}
.block-color-yellow {
	color: rgb(223,171,1);
	fill: rgb(223,171,1);
}
.block-color-teal {
	color: rgb(15,123,108);
	fill: rgb(15,123,108);
}
.block-color-blue {
	color: rgb(11,110,153);
	fill: rgb(11,110,153);
}
.block-color-purple {
	color: rgb(105,64,165);
	fill: rgb(105,64,165);
}
.block-color-pink {
	color: rgb(173,26,114);
	fill: rgb(173,26,114);
}
.block-color-red {
	color: rgb(224,62,62);
	fill: rgb(224,62,62);
}
.block-color-gray_background {
	background: rgb(235,236,237);
}
.block-color-brown_background {
	background: rgb(233,229,227);
}
.block-color-orange_background {
	background: rgb(250,235,221);
}
.block-color-yellow_background {
	background: rgb(251,243,219);
}
.block-color-teal_background {
	background: rgb(221,237,234);
}
.block-color-blue_background {
	background: rgb(221,235,241);
}
.block-color-purple_background {
	background: rgb(234,228,242);
}
.block-color-pink_background {
	background: rgb(244,223,235);
}
.block-color-red_background {
	background: rgb(251,228,228);
}
.select-value-color-default { background-color: rgba(206,205,202,0.5); }
.select-value-color-gray { background-color: rgba(155,154,151, 0.4); }
.select-value-color-brown { background-color: rgba(140,46,0,0.2); }
.select-value-color-orange { background-color: rgba(245,93,0,0.2); }
.select-value-color-yellow { background-color: rgba(233,168,0,0.2); }
.select-value-color-green { background-color: rgba(0,135,107,0.2); }
.select-value-color-blue { background-color: rgba(0,120,223,0.2); }
.select-value-color-purple { background-color: rgba(103,36,222,0.2); }
.select-value-color-pink { background-color: rgba(221,0,129,0.2); }
.select-value-color-red { background-color: rgba(255,0,26,0.2); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="a29f24e9-1ed8-4908-be3b-8e8d63bf99a1" class="page sans"><header><h1 class="page-title"></h1></header><div class="page-body"><hr id="af2ac7c2-21a7-457f-b672-d5e2dd9fea20"/><p id="f646c22b-924b-482a-8d65-a9cffa1edafd" class="">
</p><p id="2087c802-35e0-46c3-9f11-26a1533778a2" class="">
</p><nav id="6512ec68-3900-4fa3-b5e8-5aeaad05b386" class="block-color-gray table_of_contents"><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#8c5fddbb-92a9-4346-9f88-8e6c65931878">简介：</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#6c9f3784-0f4f-4dd4-a264-0d8075513ac5">问题</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#330bba83-e526-480a-bb80-6ff4614ad04c">项目目的？</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#c59e4416-5d79-4ee6-9372-369eeb820a9b">担任什么工作？</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#1f22ebab-4ae4-470d-97a6-4bdd448f1319">有什么难点？</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#0d0bdee7-0987-4bcb-a98f-9ad3eb2bfaa6">最大的困难？</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#2056594e-0c4e-44d8-8679-bc5e61aa7ce0">有什么改进吗？</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#ae6e9d8c-e237-4e37-a47a-7fd72e384195">有没有考虑过其它无锁编程的方法？为什么选了这一种？</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#82eb93bc-6f07-4477-850a-0ca73a0ea6d3">如何解决进入时Sink和Source构造顺序带来的死锁问题的？</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#9bbd89d5-b779-4e1c-9b82-403c2c47b7aa">会不会在前一个模块通知本模块后，本模块才进入wait，导致一直wait下去？</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#c50245a3-2510-4009-8196-f63f245ab3d0">每一块共享内存的大小是一样的吗？</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#1d4907b7-0d7e-4170-ad9a-e4026c3f5f50">写一下怎么mmap的？</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#a0ec9aec-b0bf-4007-8f1e-b9a666ae510f">共享内存是单个读单个写的吗？</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#720a407a-c4fc-4a08-ad73-b0105c6b92df">其它：</a></div></nav><p id="3a0be103-4bbf-4332-85ed-52d0cb5b1a90" class="">
</p><p id="28841bfd-7977-4e70-8188-3aba3816cefd" class="">
</p><p id="ca60b329-81d7-45fe-9ce8-724fdc24e344" class="">
</p><h2 id="8c5fddbb-92a9-4346-9f88-8e6c65931878" class="">简介：</h2><p id="b0c36045-f60d-4f30-ad12-47d593b3876d" class="">这个项目主要是可以用于模拟通信过程中数字信号处理过程的一个仿真平台，目前主要用于实现科研过程中物理层的一些编码、调制、滤波等，功能类似于matlab中的simulink。我们可以根据自己的信号处理的算法或者想要的处理方式来编写自己的处理模块。每个处理模块之间的是独立存在的，做到了模块间的解耦，因此各种处理模块之间就可以有各种组合，从而测出各种组合的性能，便于科研。</p><p id="0f534564-517c-4166-ac07-dca046b2dd12" class="">其实一些简单的处理用simulink等仿真软件就可以了，但是因为我的研究方向（水下磁感应通信）相对而言是一个较新的领域，有一些模块需要自己设计，并且要进行实验，所以对可移植性也有一些要求，这是像simulink这样的集成软件没法做到的。</p><p id="c6b83217-f1f2-44a9-a31d-64bb1ac92eea" class="">
</p><p id="afd66af8-5bb3-4bae-a4e1-256f575519ac" class="">
</p><p id="5c0ed920-df64-4e4b-bca2-d029dcd0f6e8" class="">这个项目主要实现的功能是一个通信仿真平台，像matlab里的simulink这种软件，它里面预置了很多信号处理的模块，我们只要把不同模块连连线就可以将各种处理组合起来，我的这个仿真平台也实现了类似的功能，而且各个模块的处理算法是可以自己定义的，模块之间解耦合，每个模块占一个线程。</p><p id="20953ea8-5208-4d94-849a-29c31077793a" class="">信号处理的流程其实是前面的模块产生数据，后面的模块消耗数据，这可能不是一一对应的，一个模块会有多个输入或输出端口，所以可以看作是端到端对应的。在每一组对应端口之间开辟了共享内存进行通信，我实现了一个环状的缓存，提高了处理的效率（一次多读多写一些数据）。主要是通过将两段连续内存映射到同一个文件来实现的，balabala。。。</p><p id="3bcc5e11-1314-4dee-87b1-52c5afc80d1a" class="">因为模块之间的连线多了可能是比较复杂的一张图，前面的模块应该先工作，后面的模块们等数据够了才读取，所以我在给他们连线的时候加了拓扑排序，这样就可以让前面的模块先开始工作，优化进入的过程。</p><p id="6cfd2dd9-4950-4bb7-ac6f-659c825540eb" class="">读写的时候也没有加锁，是通过设置读写指针，在读写之前判断能写多少读多少。然后每个模块的处理其实数据不一定是一个进一个出的关系，可能会在模块中用到插值、采样，甚至有些还要用到历史数据。所以在判断的时候的计算也稍有些复杂。</p><p id="26c4c3ed-3e30-4f3f-bf9a-730ebdfc01d1" class="">做这个项目的目的主要是，吧啦吧啦。。。</p><p id="7cd3a8c7-7c21-44e2-a831-11ab662165ac" class="">
</p><p id="1b22b1aa-e6a4-4bf1-a46a-6d260af35098" class="">
</p><p id="bda2074d-b090-4d47-b2bd-737a8bb3597f" class="">
</p><p id="020c3aed-3fa3-4a53-8c64-6170d1d124e1" class="">运行前：</p><p id="ad6ac41e-71ee-48cb-b33c-b69822d78412" class="">每个模块都是从BasicBlock继承而来。其中有Buffer和BufferReader，连接到共享内存块。</p><p id="a09bbd95-f924-40b2-89ad-232aaad03bbf" class="">在TopFlow中对不同的block进行连接，这样就可以获得多对对应关系，例如 <code>((A,0),(B,0))</code> 表示模块A的0出口连接到了模块B的0入口，然后把每个block的输入连接到对应共享内存上。</p><p id="661c5a1b-492b-4de5-9174-35d58d613e18" class="">在运行之前会检查是否有接口遗漏，以及有没有环出现。</p><p id="1acad789-24bc-43a8-97ef-c3645e83a1b1" class="">为每个模块创建一个待运行线程类，并且在每个线程类中注册回调函数（为block中的work），这样就可以在每个模块中自定义信号处理的细节。然后等待运行。</p><p id="1dcbd13d-ef13-4bdd-925b-a26e9ae10200" class="">开始运行：</p><p id="9a691425-3d86-4793-b2da-b6bf776593d5" class="">为每个线程类创建线程，开始运行。</p><p id="a727d4b8-1ca8-446f-8937-f056ed7dddb7" class="">退出：</p><p id="f9849bde-dd36-44c4-9c25-79ce1d57ec06" class="">每个模块（线程）各自退出，如果它发现它 「输入堵塞了且前一级模块已经退出了」 或 「输出堵塞了且下一级模块已经退出了」，它自己就退出。</p><p id="48ce92f8-66be-437e-97b2-58c2d643c7d3" class="">这个退出的源头可以自己设置，例如某个源模块认为自己发完了所有的数据，就将退出标识置1。</p><p id="b55d94fe-3596-459c-84e0-0e621cdc343c" class="">
</p><h2 id="6c9f3784-0f4f-4dd4-a264-0d8075513ac5" class="">问题</h2><h3 id="330bba83-e526-480a-bb80-6ff4614ad04c" class="">项目目的？</h3><p id="118f4d21-4d26-48c6-833a-419c38fa373a" class="">两个目的，一是因为我的研究方向是比较新的方向，里面有一些信号处理的算法或者处理方式要由自己定义，像simulink这种虽然也可以自定义，但是没那么方便。</p><p id="be484e6b-9b89-40c7-99aa-d147022f22ee" class="">二是这个研究最终是要落实到实验的，我的这个项目具有一定的移植性，可以比较方便地移植到linux开发板上。</p><p id="bb20c139-da7f-4a60-9a73-3b382c1c381b" class="">
</p><h3 id="c59e4416-5d79-4ee6-9372-369eeb820a9b" class="">担任什么工作？</h3><p id="99122ca2-2133-4d97-9046-dbdbe7f35719" class="">应该说整个项目都是我写的，其实并不是很难。包括整体的架构、处理模块、环状缓存这些。</p><p id="71e65c50-7a9c-4f42-bfb4-2f34c1305bec" class="">架构是参考了simulink这种信号处理软件的架构，就是各个模块之间是解耦合的，每个模块实现一部分功能，它们之间可以有不同的组合。</p><p id="ef749ff9-95bb-4c54-889e-024164cc1d32" class="">
</p><p id="2709c04c-3118-4a6b-b93c-58dd89d94970" class="">
</p><h3 id="1f22ebab-4ae4-470d-97a6-4bdd448f1319" class="">有什么难点？</h3><ol id="a6e9fa19-32db-4b9a-94fb-5ba9a9f17746" class="numbered-list" start="1"><li>环状缓存<p id="a2d7badd-c383-466d-b86c-f15b474c2ed6" class="">收发模块之间的共享内存有一个写指针和一个读指针，如果用普通的内存，需要额外地判断写指针是不是到内存尾部了，这就带来了额外的判断开销，而且如果内存开头还有很长一段可以写却放弃了CPU，就大大降低了并发能力。</p><p id="3a62d608-678e-4517-b260-04567768ac09" class="">利用环状缓存来解决这个问题。具体实现方式：用mmap，将连续的虚拟内存空间映射到同一个文件。这样文件尾部后面的地址就自动转到了开头。</p><p id="197820a1-1e84-4e4b-8c7e-2f67b4d4d516" class=""><code>readindex==writeindex</code> 表示可读为0，可写为满， <code>writeindex==readindex-1</code> 表示可写为0，可读为满。</p></li></ol><ol id="f8bf66cf-ce00-4dff-a648-8ea24fd5b98d" class="numbered-list" start="2"><li>数字通信里面，很多都不是1对1的关系，有一些要用到历史数据，有一些要插值或采样。这带来了复杂的计算，需要在进入模块的处理函数之前，先根据输入数据量和输出可用空间来计算出最多能产生多少数据。而最终究竟产生了多少数据、消耗了多少数据，都是在模块的处理函数返回时设置的（因为究竟用了多少产生了多少只有它知道），用来更新buffer的读/写指针。<p id="da1bf7a2-a652-411a-924c-25b2904fc7db" class="">而历史数据不是通过存储来实现的，而是读指针一开始就设置在读指针前面一段（历史数据的长度），更新读指针的时候同样会在写指针前面留一段，因此写指针的前面一段在下一次读之前是不会被覆盖的。这一段就是历史数据。</p></li></ol><ol id="ceda6297-d8ff-4df0-9796-7031bcb675b9" class="numbered-list" start="3"><li>这么多线程是怎么同步的？<p id="1769dd26-e619-478d-aaa2-e92aedecfe53" class="">本来这是一个多生产者多消费者的问题，写和读的时候应该加锁，但是通过读写指针的存在，可以判断当前能不能写，能不能读。这样模块的实际处理函数就不需要加锁了。</p><p id="ad3c9246-61b4-46d6-b269-0d942149a6f8" class="">因此，读写临界内存区域的时候不需要互斥。但是，一个模块（我）可能算出来当前不能读或写，那么就会阻塞，这个阻塞是通过条件变量自己阻塞自己，然后邻居模块产生了或消耗了新的数据，就通知更改我对应的条件变量并通知我，我再次检查条件变量并解锁。</p><p id="94e76f41-dc77-457c-aa82-de4f4d5d3957" class="block-color-yellow_background"><strong>总结：不需要互斥，但是需要同步。——将互斥转化为了「不同线程访问内存互不干扰」</strong></p><p id="fba6f6cf-1492-4fab-8f99-bac2fda7db3f" class="">具体实现：</p><p id="f62efd20-1efe-4688-8877-6def734062d8" class="">对于普通模块，每个线程会先计算此模块可输入多少可输出多少，如果算出来输入或者输出阻塞了，这个线程就会阻塞，等待上一级或下一级模块产生或消耗了一定数据就会通知它。</p><p id="edb69cde-7c3e-439e-aafd-72e4f940ca4b" class="">对于收发端分离的情况，会有接口模块，它们不会被阻塞，而是休眠一秒再试一次，如果是半双工收发的，再试一次之后还是没有数据，就会切换成另一种状态（收或者发）。</p></li></ol><ol id="a561975b-eb3f-47c4-a074-2414bc729178" class="numbered-list" start="4"><li>会不会线程过多影响运行效率？<p id="160a07a1-619e-4684-8301-f4fa2306b990" class="">一般来说，一个数字信号处理的过程不会需要太多模块，无非就是调制、滤波，接收端的各种同步、解调等等，一般来说都不超过10个吧。</p></li></ol><p id="044e37c6-afdb-4872-b751-c4c4bb27e567" class="">
</p><h3 id="0d0bdee7-0987-4bcb-a98f-9ad3eb2bfaa6" class="">最大的困难？</h3><ol id="91e4d2b9-a0d3-47f6-8d87-18a7db72a8ef" class="numbered-list" start="1"><li>历史数据、插值、采样情况的处理</li></ol><ol id="1624cf02-c9b1-4060-8108-263ee86ef212" class="numbered-list" start="2"><li>线程之间如何同步<p id="3a7a0032-b8a0-4407-aa8b-33f6d35cfd09" class="">线程之间是生产者和消费者的关系，它们之间的通信方式是共享内存，如果像管道那样，每个模块在写或者读的时候都加锁，那效率会很低，因此我通过引入了读写指针，在读写之前判断能读多少，能写多少，读和写互不干预。这样就不需要加锁了，相当于将互斥转化为了「不同线程访问的内存互不干扰」。</p><p id="6e3da903-57d9-4c43-b85e-b66ff8d9050f" class="">如果算出来不能读或写，本线程就会被阻塞，等待条件变量的改变和被唤醒。</p></li></ol><p id="2d44c091-1783-4767-9be5-412d57f74694" class="">
</p><h3 id="2056594e-0c4e-44d8-8679-bc5e61aa7ce0" class="">有什么改进吗？</h3><ol id="9ef6ed0a-ff94-430c-a22e-1e5778be7c14" class="numbered-list" start="1"><li>在开始运行之前增加了拓扑排序，因为数据流动是有方向的，把数据产生模块放在前面，数据接收模块放在后面。</li></ol><ol id="3380f355-5642-41b3-8e04-bdeddb22cd83" class="numbered-list" start="2"><li>将收发端分离，分离成不同的进程，它们之间的通信方式也是共享内存。并且可以为它们设置「只发/只收/半双工收发/全双工收发」，这个主要是根据我磁感应通信全向天线的研究衍生而来的，后面想利用这个试着实现全双工通信。它们可以各自启动，但是如果某一端结束了，会利用共享内存通知另一端，另一端也会结束。</li></ol><ol id="432dd5d9-b1ed-40ca-b48b-2f64575e38aa" class="numbered-list" start="3"><li>因为基带处理的一些数字调制方式经常会涉及到复数运算，滤波又涉及了大量的矢量相乘，用传统的语言自带的复数运算比较慢，所以写了个小轮子来优化复数矢量的计算。</li></ol><p id="5de0c8f5-32ed-429e-aa22-13f75e913cd8" class="">
</p><p id="ee9d5038-6f66-4a12-a904-696df707ab9e" class="">
</p><h3 id="ae6e9d8c-e237-4e37-a47a-7fd72e384195" class="">有没有考虑过其它无锁编程的方法？为什么选了这一种？</h3><p id="c8300e12-1d9e-48bb-952c-84f6691d61e1" class="">
</p><p id="cbfa7417-9fc1-4c2a-ba5a-e33667e790f4" class="">
</p><h3 id="82eb93bc-6f07-4477-850a-0ca73a0ea6d3" class="">如何解决进入时Sink和Source构造顺序带来的死锁问题的？</h3><p id="21f5f83e-bf0e-484f-8bfc-55e9bb019c3a" class="">一开始是让收发端的Sink和Source按照一致的顺序构造，就不会死锁了。</p><p id="5003b9ff-ecee-47dc-a81e-4fb71469df3f" class="">后来想，使用者可能一不小心就反向构造了，而且这样不方便，因此直接不加锁了。因为按照生活经验，发送端和接收端是独立的，可能一开始不会因为另一端不存在就不发或不收了，而是发了一段时间发现没有人收，或者收了一段时间发现没有人在发，所以就不发不收了，这在这个仿真平台是可以实现的。当发送端程序运行了开始发送，发送数据把共享空间填满之后，一直没有接收者把数据取走，就阻塞不发了，直到有接收端程序把数据取走才继续发送。</p><p id="6560250a-3197-446b-99d0-bae8b19249bc" class="">
</p><p id="dd7b6a81-3b24-435f-8aa3-3d61ac34d3ff" class="">
</p><p id="55adf4c8-ce9a-45df-a129-671fe82a00bf" class="">
</p><h3 id="9bbd89d5-b779-4e1c-9b82-403c2c47b7aa" class="">会不会在前一个模块通知本模块后，本模块才进入wait，导致一直wait下去？</h3><p id="0f3be98c-d90f-49bc-a044-cc486e2f322e" class="">不会，因为邻居模块是先设置判断变量再通知的，如果本线程在wait，说明设置变量在wait之后，也就是说通知更在wait之后；如果设置变量在wait之前，那就根本不会wait，就不用通知了。</p><p id="e1d225e3-85c4-4ee1-9317-96dae67ccafb" class="">
</p><p id="37c2fe3a-11c1-4453-a3d2-9ca076245c64" class="">
</p><h3 id="c50245a3-2510-4009-8196-f63f245ab3d0" class="">每一块共享内存的大小是一样的吗？</h3><p id="58f0af10-ebba-4281-b2f3-0f263859a981" class="">是的，是根据我电脑的页面大小来设置的，我电脑的页面大小是16384，即16KB。</p><p id="825a0ac9-ed0f-4db8-a385-50c6a465e5c8" class="">其实不同模块消耗数据的速率不一定是1:1的，所以更好的应该是根据模块的消耗比率来设置收发端的共享内存大小，这也是我之后准备优化的一个方向。</p><p id="7b67f8d6-756b-4d23-a02a-430eec40b7aa" class="">
</p><p id="7d9707b7-5af7-4062-8972-39ce5733c300" class="">
</p><p id="080b255a-5ba7-4ab7-8bbf-1cb29cf49c89" class="">
</p><h3 id="1d4907b7-0d7e-4170-ad9a-e4026c3f5f50" class="">写一下怎么mmap的？</h3><pre id="5f7fa371-83db-4ef5-8b94-1ae9cbeef881" class="code"><code>//打开一个文件
open(&quot;文件名&quot;, O_RDWR | O_CREAT | O_EXCL, 0777);
//O_EXCL和O_CREAT同时定义，如果文件已存在，CREAT会报错

//把它变成2size大小
ftruncate(fd, (off_t)(2*size));

//映射整个
void* firstcopy = mmap(0, 2*size, PROT_READ | PROT_WRITE, MAP_SHARED, fd, (off_t)0);

//unmap后一半
munmap((char*)firstcopy+size, size);

//映射后一半
void* secondcopy = mmap(firstcopy+size, size, PROT_READ | PROT_WRITE, MAP_SHARED, fd, (off_t)0);

//检查连续性
secondcopy == (char*)firstcopy+size;

//截断文件
ftruncate(fd, (off_t)size);</code></pre><p id="208c9e00-ad29-4752-9f85-447e3a42f2fc" class="">为什么要先映射2size大小的文件呢？</p><p id="67f4a0db-c3c8-472c-83bc-9ead22d971c1" class="">防止先映射前一半，再映射后一半会导致，前一半后面没有足够的空间。</p><p id="2376ea3e-c0b6-43dc-be7a-a33db19a1ace" class="">
</p><p id="a6ac000d-064a-4d71-9350-95f129912d3a" class="">
</p><p id="87754c30-cf23-4292-88d5-f9ef1b404df3" class="">
</p><h3 id="a0ec9aec-b0bf-4007-8f1e-b9a666ae510f" class="">共享内存是单个读单个写的吗？</h3><p id="bdbc0c00-2e16-4233-b307-2c72b0a877ff" class="">不是，有可能是单个写，多个读的，因为一个模块产生的数据，可能被多个下一级模块消耗，所以设置了多个读指针。</p><p id="c1710d93-5140-4628-822a-83fd369a68fe" class="">当要写之前，会根据所有的读指针来判断最多能写多少，确保不会覆盖掉任何一个读者还没读的部分。</p><p id="06c95103-5d18-4117-afc4-284860515394" class="">
</p><h3 id="720a407a-c4fc-4a08-ad73-b0105c6b92df" class="">其它：</h3><ol id="67e98947-d685-4c20-8f1b-d6516537d54e" class="numbered-list" start="1"><li>BasicBlock是一个抽象类，用作实际处理模块和其它类（流程控制、实际线程等）之间的接口，提供了</li></ol><p id="d84d5e7e-21b1-4ec0-997d-9539856498be" class="">
</p><p id="29d33562-50a8-47e4-904b-4cbd015c3d2a" class="">
</p></div></article></body></html>